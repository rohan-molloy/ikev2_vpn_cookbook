#####################
# Generated by Chef #
#####################
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:IPSEC - [0:0]
-A IPSEC -s <%= @Subnet %> -m policy --dir out --pol ipsec -j ACCEPT
-A IPSEC -s <%= @Subnet %> -j MASQUERADE
-A POSTROUTING -o <%= @Interface %> -j IPSEC 
COMMIT
*mangle
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:IPSEC - [0:0]
-A IPSEC -s <%= @Subnet %> -p tcp -m policy --dir in --pol ipsec -m tcp --tcp-flags SYN,RST SYN -m tcpmss --mss 1361:1536 -j TCPMSS --set-mss 1360
-A FORWARD -o <%= @Interface %> -j IPSEC 
COMMIT
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:VPN_LOCAL - [0:0]
:WAN_LOCAL - [0:0]
:VPN_IN - [0:0]
:VPN_OUT - [0:0]
-A WAN_LOCAL -p udp -m multiport --destination-ports 4500,500 -j ACCEPT
-A WAN_LOCAL -p ah -j ACCEPT
-A WAN_LOCAL -p esp -j ACCEPT
<% if node[:ikev2_vpn][:iptables][:allow_external_ssh]==true -%>
-A WAN_LOCAL -p tcp --dport 22 -j ACCEPT
<% end -%>
-A WAN_LOCAL -m conntrack --ctstate NEW,UNTRACKED -j DROP
-A VPN_LOCAL -p icmp -j ACCEPT
-A VPN_LOCAL -p tcp --dport ssh -j ACCEPT
<% if node[:ikev2_vpn][:iptables][:allow_all_from_vpn]==false -%>
-A VPN_LOCAL -m conntrack --ctstate NEW,UNTRACKED -j DROP
<% end -%>
-A VPN_LOCAL -j RETURN
-A VPN_IN -j RETURN 
-A VPN_OUT -j RETURN 
-A INPUT -m policy --dir in --pol ipsec -j VPN_LOCAL 
-A INPUT -i <%= @Interface %> -j WAN_LOCAL
-A FORWARD -s <%= @Subnet %> -p esp -m policy --dir in --pol ipsec -j VPN_IN
-A FORWARD -d <%= @Subnet %> -p esp -m policy --dir out --pol ipsec -j VPN_OUT
COMMIT
